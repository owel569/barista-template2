import { getDb } from '../server/db';
import { sql } from 'drizzle-orm';
import { 
  users, menuCategories, menuItems, tables, customers, reservations
} from '../shared/schema';
import { logger } from '../server/utils/logger';
import { fakerFR as faker } from '@faker-js/faker';

async function hashPassword(password: string): Promise<string> {
  const bcrypt = await import('bcryptjs');
  return bcrypt.hash(password, 12);
}

interface InitializationResult {
  success: boolean;
  message: string;
  data?: {
    admin: number;
    categories: number;
    menuItems: number;
    tables: number;
    sampleCustomers: number;
    sampleReservations: number;
  };
}

export async function initializeDatabase(): Promise<InitializationResult> {
  let db;
  try {
    console.log('ðŸ—„ï¸ DÃ©but de l\'initialisation de la base de donnÃ©es...');

    db = await getDb();
    
    // Test de connexion Ã  la base de donnÃ©es
    try {
      await db.execute(sql`SELECT 1 as test`);
      console.log('âœ… Connexion Ã  la base de donnÃ©es Ã©tablie');
    } catch (error) {
      console.error('âŒ Erreur de connexion Ã  la base de donnÃ©es');
      throw new Error('Impossible de se connecter Ã  la base de donnÃ©es');
    }

    // VÃ©rifier si des donnÃ©es existent dÃ©jÃ 
    const existingUsers = await db.select().from(users).limit(1);
    if (existingUsers.length > 0) {
      console.log('ðŸ“Š DonnÃ©es dÃ©jÃ  prÃ©sentes - initialisation ignorÃ©e');
      return { 
        success: true, 
        message: 'Base de donnÃ©es dÃ©jÃ  initialisÃ©e' 
      };
    }

    console.log('ðŸ“ CrÃ©ation des donnÃ©es initiales...');

    // Utilisation d'une transaction pour garantir l'intÃ©gritÃ© des donnÃ©es
    const result = await db.transaction(async (tx) => {
      // 1. CrÃ©ation des utilisateurs
      const adminPassword = await hashPassword('admin123');
      const employeePassword = await hashPassword('employe123');

      const usersData = [
        {
          username: 'admin',
          password: adminPassword,
          role: 'directeur',
          firstName: 'Jean',
          lastName: 'Dupont',
          email: 'admin@barista-cafe.com',
          phone: '+33123456789',
          isActive: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          username: 'employe',
          password: employeePassword,
          role: 'employe',
          firstName: 'Marie',
          lastName: 'Martin',
          email: 'marie.martin@barista-cafe.com',
          phone: '+33123456780',
          isActive: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          username: 'cuisinier',
          password: await hashPassword('cuisine123'),
          role: 'employe',
          firstName: 'Pierre',
          lastName: 'Chef',
          email: 'pierre.chef@barista-cafe.com',
          phone: '+33123456781',
          isActive: true,
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ];

      const insertedUsers = await tx.insert(users).values(usersData).returning();

      // 2. CrÃ©ation des catÃ©gories de menu
      const categoriesData = [
        { 
          name: 'CafÃ©s', 
          description: 'Nos cafÃ©s artisanaux torrÃ©fiÃ©s localement', 
          sortOrder: 1,
          isActive: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        { 
          name: 'Boissons', 
          description: 'Boissons chaudes, froides et rafraÃ®chissantes', 
          sortOrder: 2,
          isActive: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        { 
          name: 'PÃ¢tisseries', 
          description: 'PÃ¢tisseries fraÃ®ches faites maison', 
          sortOrder: 3,
          isActive: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        { 
          name: 'Plats', 
          description: 'Plats et sandwichs prÃ©parÃ©s avec soin', 
          sortOrder: 4,
          isActive: true,
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ];

      const insertedCategories = await tx.insert(menuCategories).values(categoriesData).returning();

      // 3. CrÃ©ation des articles de menu
      const menuItemsData = [
        // CafÃ©s
        { 
          name: 'Espresso Classique', 
          description: 'CafÃ© espresso italien traditionnel', 
          price: 2.50, 
          categoryId: insertedCategories[0].id,
          isAvailable: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        { 
          name: 'Cappuccino', 
          description: 'Espresso avec mousse de lait onctueuse', 
          price: 3.80, 
          categoryId: insertedCategories[0].id,
          isAvailable: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        { 
          name: 'Latte', 
          description: 'CafÃ© au lait avec art latte', 
          price: 4.20, 
          categoryId: insertedCategories[0].id,
          isAvailable: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        
        // Boissons
        { 
          name: 'ThÃ© Vert', 
          description: 'ThÃ© vert de qualitÃ© premium', 
          price: 2.80, 
          categoryId: insertedCategories[1].id,
          isAvailable: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        { 
          name: 'Chocolat Chaud', 
          description: 'Chocolat belge artisanal', 
          price: 3.50, 
          categoryId: insertedCategories[1].id,
          isAvailable: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        
        // PÃ¢tisseries
        { 
          name: 'Croissant', 
          description: 'Croissant traditionnel au beurre', 
          price: 2.20, 
          categoryId: insertedCategories[2].id,
          isAvailable: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        { 
          name: 'Cookie Chocolat', 
          description: 'Cookie aux pÃ©pites de chocolat', 
          price: 2.80, 
          categoryId: insertedCategories[2].id,
          isAvailable: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        
        // Plats
        { 
          name: 'Sandwich Club', 
          description: 'Sandwich traditionnel complet', 
          price: 6.50, 
          categoryId: insertedCategories[3].id,
          isAvailable: true,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        { 
          name: 'Salade CÃ©sar', 
          description: 'Salade fraÃ®che avec croÃ»tons', 
          price: 7.80, 
          categoryId: insertedCategories[3].id,
          isAvailable: true,
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ];

      const insertedMenuItems = await tx.insert(menuItems).values(menuItemsData).returning();

      // 4. CrÃ©ation des tables
      const tablesData = [
        { number: 1, capacity: 2, status: 'available', isActive: true, createdAt: new Date(), updatedAt: new Date() },
        { number: 2, capacity: 4, status: 'available', isActive: true, createdAt: new Date(), updatedAt: new Date() },
        { number: 3, capacity: 6, status: 'available', isActive: true, createdAt: new Date(), updatedAt: new Date() },
        { number: 4, capacity: 2, status: 'available', isActive: true, createdAt: new Date(), updatedAt: new Date() },
        { number: 5, capacity: 8, status: 'available', isActive: true, createdAt: new Date(), updatedAt: new Date() }
      ];

      const insertedTables = await tx.insert(tables).values(tablesData).returning();

      // 5. CrÃ©ation de clients de dÃ©monstration
      const sampleCustomers = Array.from({ length: 5 }, (_, i) => ({
        firstName: faker.person.firstName(),
        lastName: faker.person.lastName(),
        email: faker.internet.email(),
        phone: faker.phone.number(),
        createdAt: new Date(),
        updatedAt: new Date()
      }));

      const insertedCustomers = await tx.insert(customers).values(sampleCustomers).returning();

      // 6. CrÃ©ation de rÃ©servations de dÃ©monstration
      const sampleReservations = insertedCustomers.map((customer, index) => ({
        customerId: customer.id,
        tableId: insertedTables[index % insertedTables.length].id,
        date: faker.date.soon({ days: 7 }),
        time: '12:00',
        guests: 2,
        status: 'confirmed',
        createdAt: new Date(),
        updatedAt: new Date()
      }));

      const insertedReservations = await tx.insert(reservations).values(sampleReservations).returning();

      return {
        admin: insertedUsers[0].id,
        categories: insertedCategories.length,
        menuItems: insertedMenuItems.length,
        tables: insertedTables.length,
        sampleCustomers: insertedCustomers.length,
        sampleReservations: insertedReservations.length
      };
    });

    console.log('âœ… Base de donnÃ©es initialisÃ©e avec succÃ¨s');
    console.log('ðŸ‘¥ Comptes crÃ©Ã©s:');
    console.log('   ðŸ‘¤ Admin: admin/admin123 (Directeur)');
    console.log('   ðŸ‘¤ EmployÃ©: employe/employe123');
    console.log('   ðŸ‘¤ Cuisinier: cuisinier/cuisine123');
    console.log(`ðŸ“‚ ${result.categories} catÃ©gories crÃ©Ã©es`);
    console.log(`ðŸ½ï¸ ${result.menuItems} articles de menu crÃ©Ã©s`);
    console.log(`ðŸª‘ ${result.tables} tables crÃ©Ã©es`);
    console.log(`ðŸ‘¥ ${result.sampleCustomers} clients de dÃ©monstration crÃ©Ã©s`);
    console.log(`ðŸ“… ${result.sampleReservations} rÃ©servations de dÃ©monstration crÃ©Ã©es`);

    return { 
      success: true, 
      message: 'Initialisation terminÃ©e avec succÃ¨s', 
      data: result 
    };

  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : 'Erreur inconnue';
    console.error('âŒ Erreur lors de l\'initialisation:', errorMessage);
    
    return { 
      success: false, 
      message: `Ã‰chec de l'initialisation: ${errorMessage}` 
    };
  }
}

// ExÃ©cuter si appelÃ© directement
if (import.meta.url === `file://${process.argv[1]}`) {
  initializeDatabase()
    .then((result) => {
      if (result.success) {
        console.log('ðŸŽ‰ Initialisation terminÃ©e avec succÃ¨s');
        process.exit(0);
      } else {
        console.error('ðŸ’¥ Ã‰chec de l\'initialisation:', result.message);
        process.exit(1);
      }
    })
    .catch((error) => {
      console.error('ðŸ’¥ Erreur critique:', error instanceof Error ? error.message : 'Erreur inconnue');
      process.exit(1);
    });
}